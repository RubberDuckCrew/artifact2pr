name: Build and Test Action

on:
    push:
        branches: [main]
    pull_request:

jobs:
    build:
        name: Build Action
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

            - name: Npm setup
              uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
              with:
                  node-version: 24.13.0
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Run tests
              run: npm test

            - name: Build action
              run: npm run build

            - name: Upload action artifact
              uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
              with:
                  name: action-dist
                  path: dist

    test:
        name: Test Action
        runs-on: ubuntu-latest
        needs: build
        if: github.event_name == 'pull_request'

        permissions:
            pull-requests: write

        steps:
            - name: Create test file
              run: |
                  mkdir -p test-artifact
                  echo "Creating artifact for ${{ github.ref }} on ${{ github.sha }}" > test-artifact/test.txt

            - name: Upload test artifact
              uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
              with:
                  name: dummy-artifact
                  path: test-artifact/test.txt

            - name: Checkout repository
              uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
              with:
                  sparse-checkout: action.yml

            - name: Download action artifact
              uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
              with:
                  name: action-dist
                  path: dist

            - name: Test action in workflow
              uses: ./
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  comment-heading: "ðŸ§ª **Test Artifacts**"
                  comment-if-no-artifacts: "âš ï¸ No artifacts found in test run."

    commit-build:
        name: Commit Action Build
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/main'
        needs: build

        permissions:
            contents: write

        steps:
            - name: Check if secrets are available
              id: check-secrets
              run: |
                  echo "secrets_available=${{
                    vars.RUBBERDUCKCREW_BOT_APP_ID &&
                    secrets.RUBBERDUCKCREW_BOT_APP_PRIVATE_KEY &&
                    'true' || ''
                  }}" >> "$GITHUB_OUTPUT"

            - name: Create GitHub App token
              uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
              if: ${{ steps.check-secrets.outputs.secrets_available }}
              id: app-token
              with:
                  app-id: ${{ vars.RUBBERDUCKCREW_BOT_APP_ID }}
                  private-key: ${{ secrets.RUBBERDUCKCREW_BOT_APP_PRIVATE_KEY }}

            - name: Checkout repository
              uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

            - name: Download action artifact
              uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
              with:
                  name: action-dist
                  path: dist

            - name: Check for repo changes
              id: changes
              run: |
                  if [ -n "$(git status --porcelain --untracked-files=all dist)" ]; then
                    echo "changes=true" >> "$GITHUB_OUTPUT"
                  else
                    echo "changes=false" >> "$GITHUB_OUTPUT"
                  fi

            - name: Commit dist directory
              if: steps.changes.outputs.changes == 'true'
              uses: suzuki-shunsuke/commit-action@f28421acc277a6d6a9c1f94ea449076ad77dba67 # v0.1.0
              with:
                  commit_message: "ðŸ“¦ Update action build [skip ci]"
                  files: dist/
                  github_token: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
                  fail_on_self_push: false
