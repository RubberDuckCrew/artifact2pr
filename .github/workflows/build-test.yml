name: Build and Test Action

on:
    push:
        branches: [main]
    pull_request:

jobs:
    build:
        name: Build Action
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

            - name: Npm setup
              uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6
              with:
                  node-version: 24.11.1
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Run tests
              run: npm test

            - name: Build action
              run: npm run build

            - name: Upload action artifact
              uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
              with:
                  name: action-dist
                  path: dist

    test:
        name: Test Action
        runs-on: ubuntu-latest
        needs: build
        if: github.event_name == 'pull_request'

        permissions:
            pull-requests: write

        steps:
            - name: Create test file
              run: |
                  mkdir -p test-artifact
                  echo "Creating artifact for ${{ github.ref }} on ${{ github.sha }}" > test-artifact/test.txt

            - name: Upload test artifact
              uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
              with:
                  name: dummy-artifact
                  path: test-artifact/test.txt

            - name: Checkout repository
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
              with:
                  sparse-checkout: action.yml

            - name: Download action artifact
              uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6
              with:
                  name: action-dist
                  path: dist

            - name: Test action in workflow
              uses: ./
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  comment-heading: "ðŸ§ª **Test Artifacts**"
                  comment-if-no-artifacts: "âš ï¸ No artifacts found in test run."

    commit-build:
        name: Commit Action Build
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/main'
        needs: build

        permissions:
            contents: write

        steps:
            - name: Check if secrets are available
              id: check-secrets
              run: |
                  echo "secrets_available=${{ vars.RUBBERDUCKCREW_BOT_APP_ID && secrets.RUBBERDUCKCREW_BOT_APP_PRIVATE_KEY && 'true' || '' }}" >> "$GITHUB_OUTPUT"

            - name: Create GitHub App token
              uses: actions/create-github-app-token@7e473efe3cb98aa54f8d4bac15400b15fad77d94 # v2
              if: ${{ steps.check-secrets.outputs.secrets_available }}
              id: app-token
              with:
                  app-id: ${{ vars.RUBBERDUCKCREW_BOT_APP_ID }}
                  private-key: ${{ secrets.RUBBERDUCKCREW_BOT_APP_PRIVATE_KEY }}
        
            - name: Checkout repository
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
              with:
                  token: ${{ steps.app-token.outputs.token || github.token }}

            - name: Download action artifact
              uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6
              with:
                  name: action-dist
                  path: dist

            - name: Commit dist directory
              uses: stefanzweifel/git-auto-commit-action@28e16e81777b558cc906c8750092100bbb34c5e3 # v7
              with:
                  commit_message: "ðŸ“¦ Update action build [skip ci]"
                  file_pattern: "dist/**"
                  commit_user_name: "RubberDuckCrew Bot"
                  commit_user_email: "231319061+rubberduckcrew-bot[bot]@users.noreply.github.com"
